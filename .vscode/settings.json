import React, { useEffect, useState } from 'react';
import { Alert, ScrollView, StyleSheet, Text, TextInput, TouchableOpacity, View, ActivityIndicator } from 'react-native';
import { useAuth } from '../../context/AuthContext';

const baseURL = 'https://petgo-backend-api.onrender.comr';

type ApiOk<T> = { status: 'success'; message?: string; data?: T };
type ApiErr¬† ¬†= { status: 'error'; message: string };

type UserDTO = { id: number; name: string; email: string; cpf: string };

export default function SettingsScreen() {
  const { userId, token, logout } = useAuth();

  const [name, setName] = useState('');
  const [cpf, setCpf] = useState('');
  const [loading, setLoading] = useState(false);
  const [apiError, setApiError] = useState<string | null>(null); // Novo estado para erro

  const [currentPassword, setCurrentPassword] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmNew, setConfirmNew] = useState('');

  // Utilit√°rio: tenta parsear JSON; se vier HTML (erro 404 do servidor), cai no catch
  const parseJsonSafe = async (res: Response) => {
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) return res.json();
    const text = await res.text();
    // üö® MELHORIA: Lan√ßa um erro baseado no status HTTP, se n√£o for JSON
    throw new Error(text || `HTTP ${res.status}`);
  };

  const fetchUser = async () => {
    setApiError(null);
    if (!userId || !token) {
      setApiError('Usu√°rio n√£o autenticado.');
      return;
    }

    setLoading(true);
    try {
      const res = await fetch(`${baseURL}/users/${userId}`, {
        method: 'GET',
        headers: {
          Accept: 'application/json',
          Authorization: `Bearer ${token}`, 
        },
      });

      // üö® NOVO TRATAMENTO: Captura erros HTTP n√£o-JSON e lida com 401/403
      if (!res.ok && res.status >= 400) {
        if (res.status === 401 || res.status === 403) {
          Alert.alert("Sess√£o Expirada", "Sua sess√£o expirou. Fa√ßa login novamente.");
          await logout();
          return;
        }
        // Se a resposta n√£o for OK e n√£o for 401/403, tenta o JSON
      }

      const body: ApiOk<UserDTO> | ApiErr = await parseJsonSafe(res);
      
      if (!res.ok || (body as ApiErr).status === 'error') {
        const msg = (body as ApiErr).message || `Falha ao carregar usu√°rio (HTTP ${res.status})`;
        throw new Error(msg);
      }

      const data = (body as ApiOk<UserDTO>).data!;
      setName(data.name ?? '');
      setCpf(data.cpf ?? '');
    } catch (e: any) {
      console.error("Erro ao buscar usu√°rio:", e);
      // Se a mensagem for o HTML (erro de roteamento), exibe mensagem espec√≠fica
      if (e.message.includes('Cannot GET')) {
        setApiError('Erro de roteamento (404) do servidor. Rotas n√£o encontradas.');
      } else {
        setApiError(e.message?.toString() ?? 'Falha ao carregar usu√°rio.');
      }
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchUser(); }, [userId, token]);

  const handleSaveProfile = async () => {
    setApiError(null);
    if (!userId || !token) {
      Alert.alert('Erro', 'Voc√™ n√£o est√° autenticado.');
      return;
    }
    if (!name || !cpf) {
      Alert.alert('Valida√ß√£o', 'Informe nome e CPF.');
      return;
    }
    setLoading(true);
    try {
      const res = await fetch(`${baseURL}/users/${userId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ name, cpf }),
      });

      if (res.status === 401 || res.status === 403) {
          Alert.alert("Sess√£o Expirada", "Sua sess√£o expirou. Fa√ßa login novamente.");
          await logout();
          return;
      }
      
      const body: ApiOk<any> | ApiErr = await parseJsonSafe(res);
      if (!res.ok || (body as ApiErr).status === 'error') {
        const msg = (body as ApiErr).message || `Falha ao salvar (HTTP ${res.status})`;
        throw new Error(msg);
      }

      Alert.alert('Sucesso', 'Dados atualizados com sucesso!');
    } catch (e: any) {
      console.error(e);
      Alert.alert('Erro', e.message?.toString() ?? 'Falha ao salvar dados.');
    } finally {
      setLoading(false);
    }
  };

  const handleChangePassword = async () => {
    setApiError(null);
    if (!userId || !token) {
      Alert.alert('Erro', 'Voc√™ n√£o est√° autenticado.');
      return;
    }
    if (!currentPassword || !newPassword || !confirmNew) {
      Alert.alert('Valida√ß√£o', 'Preencha todos os campos de senha.');
      return;
    }
    if (newPassword !== confirmNew) {
      Alert.alert('Valida√ß√£o', 'A confirma√ß√£o da nova senha n√£o confere.');
      return;
    }

    setLoading(true);
    try {
      const res = await fetch(`${baseURL}/users/${userId}/password`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json',
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          currentPassword,
          newPassword,
        }),
      });

      if (res.status === 401 || res.status === 403) {
          Alert.alert("Sess√£o Expirada", "Sua sess√£o expirou. Fa√ßa login novamente.");
          await logout();
          return;
      }

      const body: ApiOk<any> | ApiErr = await parseJsonSafe(res);
      if (!res.ok || (body as ApiErr).status === 'error') {
        const msg = (body as ApiErr).message || `Falha ao alterar senha (HTTP ${res.status})`;
        throw new Error(msg);
      }

      Alert.alert('Sucesso', 'Senha alterada com sucesso!');
      setCurrentPassword('');
      setNewPassword('');
      setConfirmNew('');
    } catch (e: any) {
      console.error(e);
      Alert.alert('Erro', e.message?.toString() ?? 'Falha ao alterar senha.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <ScrollView contentContainerStyle={styles.container}>
      <Text style={styles.title}>Configura√ß√µes da Conta</Text>

      {apiError && (
        <View style={styles.errorBox}>
          <Text style={styles.errorText}>‚ö†Ô∏è Erro de API: {apiError}</Text>
          <Text style={styles.errorHint}>Se for um erro de roteamento, o servidor (Render) precisa ser corrigido/reiniciado.</Text>
        </View>
      )}

      {loading ? (
         <View style={styles.loadingContainer}>
           <ActivityIndicator size="large" color="#0B5ED7" />
           <Text style={styles.loadingText}>Carregando dados...</Text>
         </View>
      ) : (
        <>
          <Text style={styles.section}>Dados cadastrais</Text>
          <TextInput
            style={styles.input}
            placeholder="Nome completo"
            value={name}
            onChangeText={setName}
            editable={!loading}
          />
          <TextInput
            style={styles.input}
            placeholder="CPF"
            value={cpf}
            onChangeText={setCpf}
            editable={!loading}
          />
          <TouchableOpacity style={styles.btnPrimary} disabled={loading} onPress={handleSaveProfile}>
            <Text style={styles.btnText}>Salvar dados</Text>
          </TouchableOpacity>

          <Text style={[styles.section, { marginTop: 24 }]}>Alterar senha</Text>
          <TextInput
            style={styles.input}
            placeholder="Senha atual"
            secureTextEntry
            value={currentPassword}
            onChangeText={setCurrentPassword}
            editable={!loading}
          />
          <TextInput
            style={styles.input}
            placeholder="Nova senha"
            secureTextEntry
            value={newPassword}
            onChangeText={setNewPassword}
            editable={!loading}
          />
          <TextInput
            style={styles.input}
            placeholder="Confirmar nova senha"
            secureTextEntry
            value={confirmNew}
            onChangeText={setConfirmNew}
            editable={!loading}
          />
          <TouchableOpacity style={styles.btnPrimary} disabled={loading} onPress={handleChangePassword}>
            <Text style={styles.btnText}>Alterar senha</Text>
          </TouchableOpacity>
        </>
      )}

      <TouchableOpacity style={styles.btnOutline} disabled={loading} onPress={logout}>
        <Text style={[styles.btnText, { color: '#0B5ED7' }]}>Sair da conta</Text>
      </TouchableOpacity>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: { padding: 20, paddingBottom: 40 },
  title: { fontSize: 24, fontWeight: '700', marginBottom: 16 },
  section: { fontSize: 18, fontWeight: '600', marginBottom: 8 },
  input: {
    borderWidth: 1, borderColor: '#ddd', borderRadius: 12,
    padding: 14, marginBottom: 12, backgroundColor: '#fff',
  },
  btnPrimary: {
    backgroundColor: '#0B5ED7', padding: 14, borderRadius: 12,
    alignItems: 'center',
  },
  btnOutline: {
    marginTop: 28, borderWidth: 1, borderColor: '#0B5ED7',
    padding: 14, borderRadius: 12, alignItems: 'center',
  },
  btnText: { color: '#fff', fontWeight: '700' },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    paddingVertical: 50,
  },
  loadingText: {
    marginTop: 10,
    fontSize: 16,
    color: '#0B5ED7',
  },
  errorBox: {
    backgroundColor: '#ffe5e5', 
    borderColor: '#ff4d4d', 
    borderWidth: 1, 
    borderRadius: 8, 
    padding: 15,
    marginBottom: 20,
  },
  errorText: {
    color: '#cc0000', 
    fontWeight: 'bold', 
    fontSize: 14 
  },
  errorHint: {
    marginTop: 5,
    color: '#cc0000', 
    fontSize: 12,
  }
});